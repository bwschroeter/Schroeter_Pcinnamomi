---
title: "Pc time course analysis"
output:
  word_document: default
  html_document:
    df_print: paged
---

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}

library(DESeq2)
library(GEOquery)
library(tidyverse)
library(gridExtra)
library(reshape2)
library(rtracklayer)
library(dplyr)
library(TCseq)
library(edgeR)
library(SummarizedExperiment)
library(ggplot2)
library(grid)
library(clusterProfiler)
library(patchwork)
library(ggplot2)
library(RColorBrewer)
```

```{r, include=FALSE}
setwd("../shared_scripts/")

source("../shared_scripts/pcinnamomi_annotations.R", 
       local = knitr::knit_global())
source("../shared_scripts/sample_names.R", 
       local = knitr::knit_global())
source("../shared_scripts/countmatrix.R", 
       local = knitr::knit_global())

```

get locus tag and length for RPKM 
```{r}
pc.gtf <- rtracklayer::import("https://ftp.ncbi.nlm.nih.gov/genomes/genbank/protozoa/Phytophthora_cinnamomi/latest_assembly_versions/GCA_018691715.1_ASM1869171v1/GCA_018691715.1_ASM1869171v1_genomic.gtf.gz")
pc.df <- as.data.frame((pc.gtf))

pc.genes <- filter(pc.df, type == "transcript")
pc.geneids <- dplyr::select(pc.genes, seqnames, start, end, gene_id)  

pc.annotations <- pc.geneids %>% 
  distinct(gene_id, .keep_all = T)
nrow(pc.annotations)

```

```{r, stringsAsFactors=FALSE}
gene.len <- as.data.frame(pc.annotations, stringsAsFactors = F)
colnames(gene.len) <- c("chr","start", "end", "id")

gene.len$chr = (as.character(gene.len$chr)) 

is.numeric(gene.len)
head(gene.len)
#write.table(pcannot, file = "pcgeneids.tsv",quote=FALSE,sep="\t")
```

Assemble count matrix and coldata file

```{r, echo=FALSE}
tmp<-read.table("3col.tsv.gz",header=F)
x<-as.matrix(acast(tmp, V2~V1, value.var="V3"), stringsAsFactors = FALSE)
colnames(x)<-sapply(strsplit(colnames(x),"_"),"[[",1)

#head(x)
write.table(x,file="countmatrix.tsv",quote=FALSE,sep="\t")
```

Import files into r

```{r, stringsAsFactors=FALSE}
coldata <- read.table('sample_info.tsv')
Pcgenenames <- read.table('pcgeneids.tsv', row.names = 1, quote = "", sep='\t', fill = TRUE, header = TRUE)
IUM83Tanjilcountmatrix <- read.table('countmatrix.tsv') 
```

Clean countmatrix for P. cinnamomi analysis

```{r, stringsAsFactors=FALSE}

collabels <- colnames(IUM83Tanjilcountmatrix) <- (coldata$Sample)
colnames(IUM83Tanjilcountmatrix) <- collabels

IUM83Tanjilcountmatrix <- tibble::rownames_to_column(IUM83Tanjilcountmatrix, "gene_id")

IUM83CountMatrix <- IUM83Tanjilcountmatrix %>% 
  filter(str_detect(gene_id, "IUM83")) 
  
rownames(IUM83CountMatrix) <- IUM83CountMatrix$gene_id
IUM83CountMatrix <- IUM83CountMatrix [ ,-1]
IUM83CountMatrix <- as.data.frame(IUM83CountMatrix)
IUM83CountMatrix <- IUM83CountMatrix[ ,-(1:12)]
IUM83CountMatrix <- as.matrix(IUM83CountMatrix)
head(IUM83CountMatrix)

```

Clean coldata for Deseq2 normalisation

```{r}
colData <- coldata %>% 
  filter(str_detect(Sample, "Pc"))

rownames(colData) <- colData$Sample
colData <- colData [ ,-1] 
colnames(colData) <- c("sampleid", "treatment", "timepoint", "stage", "group")
colData <- dplyr::select(colData, c(sampleid, timepoint, group))  

head(colData)
```

```{r}
head(gene.len)
head(design)
head(IUM83CountMatrix)

#my_dataframe$column = as.numeric(as.character(my_dataframe$column)) 
design <- data.frame(
  sampleid = colData$sampleid,
  timepoint =  as.character(colData$time),
  group = colData$group,
  stringsAsFactors = FALSE)

isNumeric(gene.len)
isNumeric(IUM83CountMatrix)
isNumeric(design)

tca <- TCA(design = design, genomicFeature = gene.len,
 counts = IUM83CountMatrix)

```

```{r}
tca <- DBanalysis(tca)
tca <- DBanalysis(tca, filter.type = "raw", filter.value = 10, samplePassfilter = 3)

DBres <- DBresult(tca, group1 = "0h", group2 = c("18h","30h","48h"))
str(DBres, strict.width = "cut")
```

```{r}
head(DBres$`18hvs0h`)
DBres.sig <- DBresult(tca, group1 = "0h", group2 = c("18h","30h","48h"), top.sig = TRUE)
str(DBres.sig, strict.width = "cut")
```

```{r}
tca <- timecourseTable(tca, value = "expression", norm.method = "rpkm", filter = TRUE)

t <- tcTable(tca)
head(t)

```

```{r}
tca <- timeclust(tca, algo = "cm", k = 6, standardize = TRUE)
p <- timeclustplot(tca, value = "z-score(PRKM)", cols = 3)
```

```{r}
#change this depending on the number of clusters/genes
p[[1]][["labels"]][["title"]] <- paste0("Cluster 1 - 650 genes")
p[[2]][["labels"]][["title"]] <- paste0("Cluster 2 - 858 genes")
p[[3]][["labels"]][["title"]] <- paste0("Cluster 3 - 2082 genes")
p[[4]][["labels"]][["title"]] <- paste0("Cluster 4 - 1005 genes")
p[[5]][["labels"]][["title"]] <- paste0("Cluster 5 - 1460 genes")
p[[6]][["labels"]][["title"]] <- paste0("Cluster 6 - 1789 genes")
```


```{r}

combined_plot <- wrap_plots(p[[1]], p[[2]], p[[3]], p[[4]], p[[5]], p[[6]], nrow = 2)

```

```{r}

png(filename = "../Figures/PcTCA.png", width = 13800, height = 6400, pointsize = 10, res = 600)
print(combined_plot)
dev.off()

```

```{r}
# Accessing the cluster information
cluster_info <- tca@clusterRes@cluster

# Filter genes by cluster
cluster_1_genes <- names(cluster_info[cluster_info == 1])
cluster_2_genes <- names(cluster_info[cluster_info == 2])
cluster_3_genes <- names(cluster_info[cluster_info == 3])
cluster_4_genes <- names(cluster_info[cluster_info == 4])
cluster_5_genes <- names(cluster_info[cluster_info == 5])
cluster_6_genes <- names(cluster_info[cluster_info == 6])

```

```{r}
deseqtable <- read.csv("/mnt/data/barry/projects/Schroeter_Pcinnamomi/shared_scripts/finaltable.tsv")

cluster_1_genes.id <- deseqtable[deseqtable$gene_id %in% cluster_1_genes, ]
cluster_2_genes.id <- deseqtable[deseqtable$gene_id %in% cluster_2_genes, ]
cluster_3_genes.id <- deseqtable[deseqtable$gene_id %in% cluster_3_genes, ]
cluster_4_genes.id <- deseqtable[deseqtable$gene_id %in% cluster_4_genes, ]
cluster_5_genes.id <- deseqtable[deseqtable$gene_id %in% cluster_5_genes, ]
cluster_6_genes.id <- deseqtable[deseqtable$gene_id %in% cluster_6_genes, ]
```

```{r}
plas_rows <- cluster_1_genes.id[cluster_1_genes.id$Effector == c("Apoplastic effector", "Cytoplasmic effector","Apoplastic/cytoplasmic effector"), ]

```

```{r, warning=FALSE}
source("../shared_scripts/detected_pcgenes.R", 
       local = knitr::knit_global())

detectedgenes <- as.data.frame(rownames(assay(dds)))
colnames(detectedgenes) <- "gene_id"
detectedgenes.id <- dplyr::right_join(gtf.faa.omicsbox, detectedgenes, by = 'gene_id')
```

```{r}
run_enrichment <- function(gene_set, tcasets, bg) {
  ora_res <- as.data.frame(enricher(gene = gene_set,
                                    universe = bg,
                                    maxGSSize = 50000,
                                    TERM2GENE = genesets,
                                    pAdjustMethod = "fdr",
                                    pvalueCutoff = 1,
                                    qvalueCutoff = 1))
  
  ora_res$geneID <- NULL
  ora_res_names <- rownames(ora_res)
  
  ora_res$GeneRatio <- as.character(ora_res$GeneRatio)
  
  gr <- as.numeric(sapply(strsplit(as.character(ora_res$GeneRatio), "/"), "[[", 1)) /
    as.numeric(sapply(strsplit(as.character(ora_res$GeneRatio), "/"), "[[", 2))
  
  br <- as.numeric(sapply(strsplit(as.character(ora_res$BgRatio), "/"), "[[", 1)) /
    as.numeric(sapply(strsplit(as.character(ora_res$BgRatio), "/"), "[[", 2))
  
  ora_res$es <- gr/br
  ora_res <- ora_res[order(-ora_res$es), ]
  ora_res$Description <- NULL
  
  top_20 <- head(ora_res[ora_res$p.adjust < 0.05, ], 20)
  
  return(top_20)
}

bg <- detectedgenes.id$gene_id

bg.set <- data.frame("background", bg)
colnames(bg.set) <- c("term", "gene")

cluster1.set <- data.frame("Cluster1", cluster_1_genes.id$gene_id)
colnames(cluster1.set) <- c("term", "gene")

cluster2.set <- data.frame("Cluster2", cluster_2_genes.id$gene_id)
colnames(cluster2.set) <- c("term", "gene")

cluster3.set <- data.frame("Cluster3", cluster_3_genes.id$gene_id)
colnames(cluster3.set) <- c("term", "gene")

cluster4.set <- data.frame("Cluster4", cluster_4_genes.id$gene_id)
colnames(cluster4.set) <- c("term", "gene")

cluster5.set <- data.frame("Cluster5", cluster_5_genes.id$gene_id)
colnames(cluster5.set) <- c("term", "gene")

cluster6.set <- data.frame("Cluster6", cluster_6_genes.id$gene_id)
colnames(cluster6.set) <- c("term", "gene")

tcasets <- rbind(bg.set, cluster1.set, cluster2.set, cluster3.set, cluster4.set, cluster6.set, cluster6.set)

genesets <- rbind(bg.set, GOgenesets)

GOc1 <- run_enrichment(cluster_1_genes, tcasets, bg) 
rownames(GOc1) <- NULL
GOc2 <- run_enrichment(cluster_2_genes, tcasets, bg)
rownames(GOc2) <- NULL
GOc3 <- run_enrichment(cluster_3_genes, tcasets, bg)
rownames(GOc3) <- NULL
GOc4 <- run_enrichment(cluster_4_genes, tcasets, bg)
rownames(GOc4) <- NULL
GOc5 <- run_enrichment(cluster_5_genes, tcasets, bg)
rownames(GOc5) <- NULL
GOc6 <- run_enrichment(cluster_6_genes, tcasets, bg)
rownames(GOc6) <- NULL

```

```{r}
dataframes <- list(GOc1, GOc2, GOc3, GOc4, GOc5, GOc6)

combined_data <- lapply(1:length(dataframes), function(i) {
  cluster <- paste("Cluster", i)
  data <- dataframes[[i]]
  
  if (nrow(data) > 0) {
    data$Cluster <- cluster
    data$Cluster <- cluster
  data
  }
  
  data
})

# Combine the dataframes into a single dataframe
combined_dataframe <- do.call(rbind, combined_data)

# Print the combined dataframe
print(combined_dataframe)
```

```{r}
write.csv(combined_dataframe, file = "/mnt/data/barry/projects/Schroeter_Pcinnamomi/Timecourse analysis/TCseqcluster_ORA.tsv", row.names = FALSE)
```


```{r}
# Sort the combined_dataframe by cluster and -log10(p-adjusted)
sorted_dataframe <- combined_dataframe[order(combined_dataframe$Cluster, -log10(combined_dataframe$p.adjust)), ]

# Sort the dataframe by p.adjust in descending order
sorted_dataframe <- sorted_dataframe %>%
  arrange(Cluster, desc(p.adjust))

# Group by Cluster and select the top 5 rows with the highest p.adjust values
top_5_highest_p_adjust <- sorted_dataframe %>%
  group_by(Cluster) %>%
  top_n(5, -p.adjust) %>%
  ungroup()

# View the updated dataframe
head(top_5_highest_p_adjust, 15)

num_clusters <- 7
cluster_colors <- brewer.pal(num_clusters, "Set2")

png(filename = "../Figures/PcTCA_ora.png", width = 13800, height = 6400, res = 600)

plot <- ggplot(top_5_highest_p_adjust, aes(x = -log10(p.adjust), y = reorder(ID, -log10(p.adjust)), fill = Cluster)) +
  geom_bar(stat = "identity", orientation = "y") +
  labs(title = "", x = "-log10(p-adjusted)", y = "", fill = "") +
  scale_fill_manual(values = cluster_colors) +
  theme_minimal() +
  theme(axis.title.y = element_text(angle = 0, hjust = 1, size = 12), 
        axis.text.y = element_text(size = 24, margin = margin(r = 0)),
        legend.text = element_text(size = 24),
        axis.text.x = element_text(size = 24),  
        axis.line.x = element_line(size = 1),
        legend.title = element_text(size = 24),
        axis.title.x = element_text(size = 24)  
  ) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed", color = "black") + 
  scale_x_continuous(limits = c(0, max(-log10(top_5_highest_p_adjust$p.adjust) * 1.2)))

print(plot)

dev.off()

```

```{r}
knitr::include_graphics("../Figures/PcTCA.png")
```

```{r}
knitr::include_graphics("../Figures/PcTCA_ora.png")
```

```{r}
sessionInfo()
```

