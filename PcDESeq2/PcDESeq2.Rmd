---
title: "PcDESeq2"
author: "BWSchroeter"
date: "2023-05-22"
output:
  word_document: default
  html_document: default
---

```{r, load libraries, include=FALSE}
#library("kableExtra")
library(DESeq2)
library(GEOquery)
library(tidyverse)
library(gridExtra)
library(reshape2)
library(rtracklayer)
library(dplyr)
library(edgeR)
library(clusterProfiler)
library(pheatmap)
library(RColorBrewer)
library("eulerr")
library(officer)
library(flextable)


```

Upload files

```{r, include=FALSE}
setwd("../shared_scripts")

#import raw files
source("../shared_scripts/pcinnamomi_annotations.R", 
       local = knitr::knit_global())
source("../shared_scripts/sample_names.R", 
       local = knitr::knit_global())
source("../shared_scripts/countmatrix.R", 
       local = knitr::knit_global())

```

Clean coldata for Deseq2 normalisation

```{r}
colData <- coldata %>% 
  filter(str_detect(Sample, "Pc"))

rownames(colData) <- colData$Sample
colData <- colData [ ,-1] 

# making sure the row names in colData matches to column names in counts_data
all(colnames(IUM83CountMatrix) %in% rownames(colData))
```

```{r}
# Create sample information
sampleNames <- colData$Sample
condition <- colData$Stage
timepoint <- colData$Time

colDATA <- data.frame(sampleNames,
                      condition,
                      timepoint,
                      stringsAsFactors = T)

# Create the DESeqDataSet object
dds <- DESeqDataSetFromMatrix(countData = IUM83CountMatrix,
                              colData = colDATA,
                              design = ~ condition)

nrow(dds)
dds <- dds[rowMeans(counts(dds)) >10,]
nrow(dds)

```

```{r}
vsd <- vst(dds, blind = FALSE)
head(assay(vsd), 3)

rld <- rlog(dds, blind = FALSE)
head(assay(rld), 3)
                    
```

```{r}
ds <- estimateSizeFactors(dds)

df <- bind_rows(
  as.data.frame(log2(counts(dds, normalized=F)[, 1:2]+1)) %>%
         mutate(transformation = "log2(x + 1)"),
  as.data.frame(assay(vsd)[, 1:2]) %>% mutate(transformation = "vst"),
  as.data.frame(assay(rld)[, 1:2]) %>% mutate(transformation = "rlog"))
  
colnames(df)[1:2] <- c("x", "y")  

lvls <- c("log2(x + 1)", "vst", "rlog")
df$transformation <- factor(df$transformation, levels=lvls)

ggplot(df, aes(x = x, y = y)) + geom_hex(bins = 80) +
  coord_fixed() + facet_grid( . ~ transformation) 
```

```{r}
sampleDists <- dist(t(assay(rld)))
sampleDists

sampleDistMatrix <- as.matrix( sampleDists )
rownames(sampleDistMatrix) <- paste( vsd$dex, vsd$cell, sep = " - " )
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)

pheatmap(sampleDistMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists,
         col = colors)

```

```{r}

PCA <- plotPCA(rld, c("timepoint", "sampleNames"), returnData = TRUE)
percentVar <- round(100 * attr(PCA, "percentVar"))

ggplot(PCA, aes(PC1, PC2, color = condition)) +
  geom_point(size = 5) +
  geom_point(shape = 21, fill = "transparent", colour = "black", size = 5) +
  xlab(paste0("PC1 (", percentVar[1], "%)")) +
  ylab(paste0("PC2 (", percentVar[2], "%)")) +
  coord_fixed() +
  theme_bw() +
  theme(axis.line = element_line(color = "black"),
        panel.border = element_rect(color = "black"),
        panel.grid.major = element_line(color = "grey"),  
        panel.grid.minor = element_blank(),
        legend.position = c(0.05, 0.40),  
        legend.justification = c(0, 1),  
        legend.background = element_rect(color = "black", fill = "white", size = 0.5),  
        legend.key.size = unit(1, "lines"))  

```

```{r}
sampleDists <- dist(t(assay(vsd)))
sampleDists

sampleDistMatrix <- as.matrix( sampleDists )
rownames(sampleDistMatrix) <- paste( vsd$dex, vsd$cell, sep = " - " )
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists,
         col = colors)

```

```{r}

PCA <- plotPCA(vsd, c("timepoint", "sampleNames"), returnData = TRUE)
percentVar <- round(100 * attr(PCA, "percentVar"))

ggplot(PCA, aes(PC1, PC2, color = condition)) +
  geom_point(size = 5) +
  geom_point(shape = 21, fill = "transparent", colour = "black", size = 5) +
  xlab(paste0("PC1 (", percentVar[1], "%)")) +
  ylab(paste0("PC2 (", percentVar[2], "%)")) +
  coord_fixed() +
  theme_bw() +
  theme(axis.line = element_line(color = "black"),
        panel.border = element_rect(color = "black"),
        panel.grid.major = element_line(color = "grey"),  
        panel.grid.minor = element_blank(),
        legend.position = c(0.05, 0.95),  
        legend.justification = c(0, 1),  
        legend.background = element_rect(color = "black", fill = "white", size = 0.5), 
        legend.key.size = unit(1, "lines"))  

```

```{r}

png("../Figures/PCA_vst.png", width = 10, height = 6, units = "in", res = 300)

ggplot(PCA, aes(PC1, PC2, color = condition)) +
  geom_point(size = 5) +
  geom_point(shape = 21, fill = "transparent", colour = "black", size = 5) +
  xlab(paste0("PC1 (", percentVar[1], "%)")) +
  ylab(paste0("PC2 (", percentVar[2], "%)")) +
  coord_fixed() +
  theme_bw() +
  theme(axis.line = element_line(color = "black"),
        panel.border = element_rect(color = "black"),
        panel.grid.major = element_line(color = "grey"),  
        panel.grid.minor = element_blank(),
        legend.position = c(0.05, 0.95),  
        legend.justification = c(0, 1),  
        legend.background = element_rect(color = "black", fill = "white", size = 0.5),
        legend.key.size = unit(1, "lines"))  

dev.off()
```

```{r}
dds$condition <- relevel(dds$timepoint, ref = "0h")

dds <- DESeq(dds)

as.data.frame(colData(dds))
```

```{r, pheatmap annotation}
col_ann <- colData[,c(1,3)]
rownames(col_ann) <- col_ann$Sample
col_ann <- data.frame(col_ann)
col_ann$Stage <- as.factor(col_ann$Stage)
col_ann <- col_ann[order(col_ann$Stage),]
col_ann$sample_ID <- NULL
head(col_ann, 12)

```

```{r, Early summary}
res_early_vs_vegetative <- results(dds, contrast = c("condition", "18h", "0h"))
summary(res_early_vs_vegetative)
(res_early_vs_vegetative)
```

```{r, Top 50 most significant genes based on p-value - Early}
top_genes_early <- head(res_early_vs_vegetative[order(res_early_vs_vegetative$pvalue), ], 50)

top_gene_expression_early.id <- as.data.frame(top_genes_early)
top_gene_expression_early.id$gene_id <- rownames(top_gene_expression_early.id)
top_gene_expression_early.id <- dplyr::right_join(pc.annotations, top_gene_expression_early.id, by = 'gene_id') %>%
  arrange(padj)

view(top_gene_expression_early.id)

# Extract the expression values for the top genes
top_gene_expression_early <- assay(dds)[rownames(top_genes_early), ]

# Extract the expression values for the top genes and select columns 1 to 6
top_gene_expression_early <- top_gene_expression_early[, 1:6]

# Create a matrix of log2-transformed expression values
log2_expression_early <- log2(top_gene_expression_early + 1)

png(filename = "../Figures/Early_pheatmap-scaledl2fc.png", width = 4800, height = 4800, pointsize = 10, res = 600)

pheatmap(top_gene_expression_early, scale = "row",
         cluster_rows = T, cluster_cols = T,
         display_numbers = F, 
         fontsize_row = 8, fontsize_col = 8, 
         annotation_col = col_ann,
         show_colnames = FALSE,
         cellheight = 8, cellwidth = 40,
         main = "Top 50 Genes by p-value (Early)")

dev.off()

```



```{r, Early volcano padj}
# early DE 
ede <- as.data.frame(res_early_vs_vegetative[order(res_early_vs_vegetative$padj), ])
# early significant 
edesig <- subset(ede, padj < 0.05)

edeup_dn <- subset(ede, (log2FoldChange > 2 | log2FoldChange < -2) & padj < 0.05)

edeup <- rownames(subset(ede, log2FoldChange > 2 & padj < 0.05))
ededn <- rownames(subset(ede, log2FoldChange < -2 & padj < 0.05))
# Calculate the gene counts
EDEUP <- length(edeup)
EDEDN <- length(ededn)

SUBHEADER <- paste(EDEUP, "Up-regulated genes ,", EDEDN, " Down-regulated genes")

evol_df <- data.frame(
  padj = ede$padj,
  log2FoldChange = ede$log2FoldChange,
  baseMean = ede$baseMean,
  gene_id = rownames(ede)
  )
etop_genes <- head(evol_df[order(evol_df$padj), ], 50)

png(filename = "../Figures/EarlyDEvolcano.png", width = 4800, height = 4800, pointsize = 10, res = 600)

ggplot(evol_df, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(color = "black", alpha = 0.5, size = 2, shape = 19) +
  geom_point(data = edesig, aes(color = "grey"), size = 2, shape = 19) +
  geom_point(data = edeup_dn, aes(color = "significantly expressed"), size = 2, shape = 19) +
  geom_text(data = subset(etop_genes, baseMean > 1000), aes(label = gene_id),
         hjust = -0.1, vjust = 0.1, color = "black", size = 3, angle = -45) +
         labs(x = "log2foldchange", y = "log10 p-value") +
  scale_color_manual(values = c("significantly expressed" = "turquoise"),
                     name = "") +
  theme_bw() +
  theme(axis.line = element_line(color = "black"),
        panel.border = element_rect(color = "black"),
        panel.grid.major = element_line(color = "grey"),  
        panel.grid.minor = element_blank(),
        legend.position = c(0.05, 0.99),  
        legend.justification = c(0, 1),  
        legend.background = element_rect(fill = NA, size = 0.5),
        legend.key.size = unit(1, "lines")) +
  ggtitle(expression(paste(italic("Phytophthora cinnamomi"), " gene expression during early interaction"))) +
  labs(subtitle = SUBHEADER) +
  theme(plot.title = element_text(face = "bold", size = 16)) 

dev.off()
```

```{r, Top 50 most significant genes based on p-value/baseMean - Early}
top_genes_early <- as.data.frame(res_early_vs_vegetative[order(res_early_vs_vegetative$pvalue), ])

top_genes_early <- top_genes_early %>%
  dplyr::filter(baseMean >= 1000) %>%
  arrange(pvalue) %>%
  head(50)

top_gene_expression_early.id <- as.data.frame(top_genes_early)
top_gene_expression_early.id$gene_id <- rownames(top_gene_expression_early.id)
top_gene_expression_early.id <- dplyr::right_join(gtf.omicsbox, top_gene_expression_early.id, by = 'gene_id') %>%
  arrange(padj)

# Extract the expression values for the top genes
top_gene_expression_early <- assay(dds)[rownames(top_genes_early), ]

# Extract the expression values for the top genes and select columns 1 to 6
top_gene_expression_early <- top_gene_expression_early[, 1:6]

# Create a matrix of log2-transformed expression values
log2_expression_early <- log2(top_gene_expression_early + 1)

png(filename = "../Figures/Early_pheatmap-scaledl2fc2.png", width = 4800, height = 4800, pointsize = 10, res = 600)

pheatmap(top_gene_expression_early, scale = "row",
         cluster_rows = T, cluster_cols = T,
         display_numbers = F, 
         fontsize_row = 8, fontsize_col = 8, 
         annotation_col = col_ann,
         show_colnames = FALSE,
         cellheight = 8, cellwidth = 40,
         main = "Top 50 Genes by p-value (Early)")

dev.off()
```
```{r}
# function to save tables landscape
sect_properties <- prop_section(
  page_size = page_size(
    orient = "landscape",
    width = 8.7, height = 11.7
  ),
  type = "continuous",
  page_margins = page_mar()
)
```

```{r}
earlydeseqtable <- head(top_gene_expression_early.id, 10)

# Order columns logically 
earlydeseqtable <- earlydeseqtable %>% 
  dplyr::select(c(gene_id, protein_id, product, GO_terms, baseMean, log2FoldChange, padj))

earlydeseqtable$baseMean <- round(earlydeseqtable$baseMean)
earlydeseqtable$log2FoldChange <- round(earlydeseqtable$log2FoldChange, 2)
earlydeseqtable$padj <- as.numeric(earlydeseqtable$padj)
# Format the 'padj' column to scientific notation with two decimal places
earlydeseqtable$padj <- sprintf("%.2e", earlydeseqtable$padj)

# Rename columns 
colnames(earlydeseqtable) <- c("Gene name", "Protein name", "Product", "GO term", "baseMean", "log2FoldChange", "padj")

view(earlydeseqtable)

earlydeseqtable <-  flextable(earlydeseqtable) %>%
  theme_booktabs() %>%
  align(align = "center", part = c("all"))

print(earlydeseqtable)

#save_as_docx(earlydeseqtable, path =  "/mnt/data/barry/projects/Schroeter_Pcinnamomi/sequencing_stats/earlydeseqtable.docx", pr_section = sect_properties)
```

```{r, Early volcano basemean}
# early DE 
ede <- as.data.frame(res_early_vs_vegetative[order(res_early_vs_vegetative$padj), ])
# early significant 
edesig <- subset(ede, padj < 0.05)

edeup_dn <- subset(ede, (log2FoldChange > 2 | log2FoldChange < -2) & padj < 0.05)

edeup <- rownames(subset(ede, log2FoldChange > 2 & padj < 0.05))
ededn <- rownames(subset(ede, log2FoldChange < -2 & padj < 0.05))
# Calculate the gene counts
EDEUP <- length(edeup)
EDEDN <- length(ededn)

SUBHEADER <- paste(EDEUP, "Up-regulated genes ,", EDEDN, " Down-regulated genes")

evol_df <- data.frame(
  padj = ede$padj,
  log2FoldChange = ede$log2FoldChange,
  baseMean = ede$baseMean,
  gene_id = rownames(ede)
  )
etop_genes <- head(evol_df[order(evol_df$padj), ], 10)

png(filename = "../Figures/EarlyDEvolcano2.png", width = 4800, height = 4800, pointsize = 10, res = 600)

ggplot(evol_df, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(color = "black", alpha = 0.5, size = 2, shape = 19) +
  geom_point(data = edesig, aes(color = "grey"), size = 2, shape = 19) +
  geom_point(data = edeup_dn, aes(color = "significantly expressed"), size = 2, shape = 19) +
  geom_text(data = subset(etop_genes, baseMean > 1000), aes(label = gene_id),
         hjust = -0.1, vjust = 0.1, color = "black", size = 3, angle = -45) +
         labs(x = "log2foldchange", y = "log10 p-value") +
  scale_color_manual(values = c("significantly expressed" = "turquoise"),
                     name = "") +
  theme_bw() +
  theme(axis.line = element_line(color = "black"),
        panel.border = element_rect(color = "black"),
        panel.grid.major = element_line(color = "grey"),  
        panel.grid.minor = element_blank(),
        legend.position = c(0.05, 0.99),  
        legend.justification = c(0, 1),  
        legend.background = element_rect(fill = NA, size = 0.5),
        legend.key.size = unit(1, "lines")) +
  ggtitle(expression(paste(italic("Phytophthora cinnamomi"), " gene expression during early interaction"))) +
  labs(subtitle = SUBHEADER) +
  theme(plot.title = element_text(face = "bold", size = 16)) 

dev.off()
```

```{r}
#knitr::include_graphics("../Figures/Early_pheatmap-scaledl2fc.png")
#knitr::include_graphics("../Figures/Early_pheatmap-scaledl2fcbaseMean.png")
#knitr::include_graphics("../Figures/EarlyDEvolcano.png")
#knitr::include_graphics("../Figures/EarlyDEvolcano2.png")
```

```{r, Middle summary}
# To compare "Middle" vs "Vegetative"
res_middle_vs_vegetative <- results(dds, contrast =c ("condition", "30h", "0h"))
summary(res_middle_vs_vegetative)
res_middle_vs_vegetative
```

```{r, Top 50 most significant genes based on p-value/baseMean - Middle}
top_genes_mid <- as.data.frame(res_middle_vs_vegetative[order(res_middle_vs_vegetative$pvalue), ])

top_genes_mid <- top_genes_mid %>%
  dplyr::filter(baseMean >= 1000) %>%
  arrange(pvalue) %>%
  head(50)


top_gene_expression_mid.id <- as.data.frame(top_genes_mid)
top_gene_expression_mid.id$gene_id <- rownames(top_gene_expression_mid.id)
top_gene_expression_mid.id <- dplyr::right_join(gtf.omicsbox, top_gene_expression_mid.id, by = 'gene_id') %>%
  arrange(padj)

# Extract the expression values for the top genes
top_gene_expression <- assay(dds)[rownames(top_genes_mid), ]

# Extract the expression values for the top genes and the selected columns (1 to 3 and 7 to 9)
top_gene_expression_mid <- assay(dds)[rownames(top_genes_mid), c(1:3, 7:9)]

# Create a matrix of log2-transformed expression values
log2_expression_mid <- log2(top_gene_expression_mid + 1)

png(filename = "../Figures/Mid_pheatmap-scaledl2fc.png", width = 4800, height = 4800, pointsize = 10, res = 600)

pheatmap(log2_expression_mid,  scale = "row",
         cluster_rows = TRUE, cluster_cols = T,
         display_numbers = F, 
         fontsize_row = 8, fontsize_col = 8, 
         annotation_col = col_ann,
         show_colnames = FALSE,
         cellheight = 8, cellwidth = 40,
         main = "Top 50 Genes by p-value (Middle)")

dev.off()
```

```{r, middle volcano}
# late DE 
mde <- as.data.frame(res_middle_vs_vegetative[order(res_middle_vs_vegetative$padj), ])
# late significant 
mdesig <- subset(mde, padj < 0.05)

mdeup_dn <- subset(mde, (log2FoldChange > 2 | log2FoldChange < -2) & padj < 0.05)

mdeup <- rownames(subset(mde, log2FoldChange > 2 & padj < 0.05))
mdedn <- rownames(subset(mde, log2FoldChange < -2 & padj < 0.05))
# Calculate the gene counts
MDEUP <- length(mdeup)
MDEDN <- length(mdedn)

midgenesDE <- head(top_gene_expression_mid.id[order(top_gene_expression_mid.id$pvalue), ], 10)
midgenesDE <- midgenesDE$gene_id
# Create the subtitle using the gene counts
SUBHEADER <- paste(MDEUP, "Up-regulated genes ,", MDEDN, " Down-regulated genes")

mvol_df <- data.frame(
  padj = mde$padj,
  log2FoldChange = mde$log2FoldChange,
  baseMean = mde$baseMean,
  gene_id = rownames(mde)
  )
mtop_genes <- head(mvol_df[order(mvol_df$padj), ], 50)

png(filename = "../Figures/MidDEvolcano.png", width = 4800, height = 4800, pointsize = 10, res = 600)

ggplot(mvol_df, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(color = "black", alpha = 0.5, size = 2, shape = 19) +
  geom_point(data = mdesig, aes(color = "detected"), size = 2, shape = 19) +
  geom_point(data = mdeup_dn, aes(color = "significantly expressed"), size = 2, shape = 19) +
  geom_text(data = subset(mtop_genes, baseMean > 1000), aes(label = gene_id),
         hjust = -0.1, vjust = 0.1, color = "black", size = 3, angle = -45) +
         labs(x = "log2foldchange", y = "log10 p-value") +
  scale_color_manual(values = c("significantly expressed" = "turquoise"),
                     name = "") +
  theme_bw() +
  theme(axis.line = element_line(color = "black"),
        panel.border = element_rect(color = "black"),
        panel.grid.major = element_line(color = "grey"),  
        panel.grid.minor = element_blank(),
        legend.position = c(0.05, 0.99),  
        legend.justification = c(0, 1),  
        legend.background = element_rect(fill = NA, size = 0.5),
        legend.key.size = unit(1, "lines")) +
  ggtitle(expression(paste(italic("Phytophthora cinnamomi"), " gene expression during mid interaction"))) +
  labs(subtitle = SUBHEADER) +
  theme(plot.title = element_text(face = "bold", size = 16)) 

dev.off()
```

```{r}
middeseqtable <- head(top_gene_expression_mid.id, 10)

# Order columns logically 
middeseqtable <- middeseqtable %>% 
  dplyr::select(c(gene_id, protein_id, product, GO_terms, baseMean, log2FoldChange, padj))

middeseqtable$baseMean <- round(middeseqtable$baseMean)
middeseqtable$log2FoldChange <- round(middeseqtable$log2FoldChange, 2)
middeseqtable$padj <- as.numeric(middeseqtable$padj)
# Format the 'padj' column to scientific notation with two decimal places
middeseqtable$padj <- sprintf("%.2e", middeseqtable$padj)

# Rename columns 
colnames(middeseqtable) <- c("Gene name", "Protein name", "Product", "GO term", "baseMean", "log2FoldChange", "padj")

view(middeseqtable)

earlydeseqtable <-  flextable(earlydeseqtable) %>%
  theme_booktabs() %>%
  align(align = "center", part = c("all"))

print(earlydeseqtable)

#save_as_docx(earlydeseqtable, path =  "/mnt/data/barry/projects/Schroeter_Pcinnamomi/sequencing_stats/earlydeseqtable.docx", pr_section = sect_properties)
```

```{r, late summary}
# To compare "Late" vs "Vegetative"
res_late_vs_vegetative <- results(dds, contrast = c("condition", "48h", "0h"))
summary(res_late_vs_vegetative)
(res_late_vs_vegetative)
```

```{r, late top 50 most significant genes based on p-value }
top_genes_late <- head(res_late_vs_vegetative[order(res_late_vs_vegetative$pvalue), ], 50)

top_gene_expression_late.id <- as.data.frame(top_genes_late)
top_gene_expression_late.id$gene_id <- rownames(top_gene_expression_late.id)
top_gene_expression_late.id <- dplyr::right_join(gtf.omicsbox, top_gene_expression_late.id, by = 'gene_id') %>%
  arrange(padj)

# Extract the expression values for the top genes and the selected columns (1 to 3 and 10 to 12)
top_gene_expression_late <- assay(dds)[rownames(top_genes_late), c(1:3, 10:12)]

# Create a matrix of log2-transformed expression values
log2_expression_late <- log2(top_gene_expression_late + 1)

png(filename = "../Figures/Late_pheatmap-scaledl2fc.png", width = 4800, height = 4800, pointsize = 10, res = 600)

pheatmap(log2_expression_late, scale = "row",
         cluster_rows = TRUE, cluster_cols = T,
         display_numbers = F, 
         fontsize_row = 8, fontsize_col = 8, 
         annotation_col = col_ann,
         show_colnames = FALSE,
         cellheight = 8, cellwidth = 40,
         main = "Top 50 Genes by p-value (Late)")
       
dev.off()
```

```{r, late volcano}
# late DE 
lde <- as.data.frame(res_late_vs_vegetative[order(res_late_vs_vegetative$padj), ])
# late significant 
ldesig <- subset(lde, padj < 0.05)

ldeup_dn <- subset(lde, (log2FoldChange > 2 | log2FoldChange < -2) & padj < 0.05)

ldeup <- rownames(subset(lde, log2FoldChange > 2 & padj < 0.05))
ldedn <- rownames(subset(lde, log2FoldChange < -2 & padj < 0.05))
# Calculate the gene counts
LDEUP <- length(ldeup)
LDEDN <- length(ldedn)

lategenesDE <- head(top_gene_expression_late.id[order(top_gene_expression_late.id$pvalue), ], 10)
lategenesDE <- lategenesDE$gene_id

# Create the subtitle using the gene counts
SUBHEADER <- paste(LDEUP, "Up-regulated genes ,", LDEDN, " Down-regulated genes")

lvol_df <- data.frame(
  padj = lde$padj,
  log2FoldChange = lde$log2FoldChange,
  baseMean = lde$baseMean,
  gene_id = rownames(lde)
  )
ltop_genes <- head(lvol_df[order(lvol_df$padj), ], 50)

png(filename = "../Figures/LateDEvolcano.png", width = 4800, height = 4800, pointsize = 10, res = 600)

ggplot(lvol_df, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(color = "black", alpha = 0.5, size = 2, shape = 19) +
  geom_point(data = ldesig, aes(color = "grey"), size = 2, shape = 19) +
  geom_point(data = ldeup_dn, aes(color = "significantly expressed"), size = 2, shape = 19) +
  geom_text(data = subset(ltop_genes, baseMean > 1000), aes(label = gene_id),
         hjust = -0.1, vjust = 0.1, color = "black", size = 3, angle = -45) +
         labs(x = "log2foldchange", y = "log10 p-value") +
  scale_color_manual(values = c("significantly expressed" = "turquoise"),
                     name = "") +
  theme_bw() +
  theme(axis.line = element_line(color = "black"),
        panel.border = element_rect(color = "black"),
        panel.grid.major = element_line(color = "grey"),  
        panel.grid.minor = element_blank(),
        legend.position = c(0.05, 0.99),  
        legend.justification = c(0, 1),  
        legend.background = element_rect(fill = NA, size = 0.5),
        legend.key.size = unit(1, "lines")) +
  ggtitle(expression(paste(italic("Phytophthora cinnamomi"), " gene expression during late interaction"))) +
  labs(subtitle = SUBHEADER) +
  theme(plot.title = element_text(face = "bold", size = 16)) 

dev.off()
```

```{r}
deseqtable <- read.csv("/mnt/data/barry/projects/Schroeter_Pcinnamomi/shared_scripts/finaltable.tsv")

colnames(deseqtable) <- c("gene_id", "Protein name", "Product", "GO BP terms", "GO BP IDs", "GO MF terms", "GO MF IDs", "GO CC terms", "GO CC IDs", "SP, TM", "Effector")

```

```{r}
duplicates <- any(duplicated(earlydeseqtable$Gene_name))

# Print the result
if (duplicates) {
  cat("The 'Gene name' column contains duplicates.\n")
} else {
  cat("The 'Gene name' column does not contain duplicates.\n")
}
```


```{r}
earlydeseqtable <- head(top_gene_expression_early.id, 50)

earlydeseqtable <- earlydeseqtable %>% 
  dplyr::select(c(gene_id, baseMean, log2FoldChange, padj))

earlydeseqtable$baseMean <- round(earlydeseqtable$baseMean)
earlydeseqtable$log2FoldChange <- round(earlydeseqtable$log2FoldChange, 2)
earlydeseqtable$padj <- as.numeric(earlydeseqtable$padj)
# Format the 'padj' column to scientific notation with two decimal places
earlydeseqtable$padj <- sprintf("%.2e", earlydeseqtable$padj)

earlydeseqtable <-  deseqtable %>%
  right_join(earlydeseqtable, by = "gene_id")

view(earlydeseqtable)

earlydeseqtable.ft <-  flextable(earlydeseqtable) %>%
  theme_booktabs() %>%
  add_header_row(values = c("", "Biological Process", "Molecular Function", "Cellular Component", "Prediction", "Expression values"), colwidths = c(3,2,2,2,2,3)) %>%
  align(align = "center", part = c("all"))

print(earlydeseqtable.ft)

save_as_docx(earlydeseqtable.ft, path =  "/mnt/data/barry/projects/Schroeter_Pcinnamomi/sequencing_stats/earlydeseqtable.docx", pr_section = sect_properties)
```


## Session information

```{r,session}

sessionInfo()

```
