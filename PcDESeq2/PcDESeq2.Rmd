---
title: "PcDESeq2"
author: "BWSchroeter"
date: "2023-05-22"
output: html_document
---

```{r, load libraries, include=FALSE}

library("kableExtra")
library(WGCNA)
library(DESeq2)
library(GEOquery)
library(tidyverse)
library(gridExtra)
library(reshape2)
library(rtracklayer)
library(dplyr)
library(edgeR)
library(clusterProfiler)
library(pheatmap)
library(RColorBrewer)
```

Upload files

```{r}
coldata <- read.table('sample_info.tsv')
Pcgenenames <- read.table('pcgeneids.tsv', row.names = 1, quote = "", sep='\t', fill = TRUE, header = TRUE)
IUM83Tanjilcountmatrix <- read.table('countmatrix.tsv') 

```

Clean countmatrix for P. cinnamomi analysis

```{r}
collabels <- colnames(IUM83Tanjilcountmatrix) <- (coldata$Sample)
colnames(IUM83Tanjilcountmatrix) <- collabels

IUM83Tanjilcountmatrix <- tibble::rownames_to_column(IUM83Tanjilcountmatrix, "gene_id")

IUM83CountMatrix <- IUM83Tanjilcountmatrix %>% 
  filter(str_detect(gene_id, "IUM83")) 
  
rownames(IUM83CountMatrix) <- IUM83CountMatrix$gene_id
IUM83CountMatrix <- IUM83CountMatrix [ ,-1]
IUM83CountMatrix <- as.data.frame(IUM83CountMatrix)
IUM83CountMatrix <- IUM83CountMatrix[ ,-(1:12)]

head(IUM83CountMatrix)
#write.table(IUM83CountMatrix, file = "Pc_countmatrix.tsv",quote=FALSE,sep="\t")
```
```{r}

summary(IUM83CountMatrix)
par(mar = c(8, 4, 4, 1) + 0.1)
barplot(colSums(IUM83CountMatrix)/1e6, las = 3)
```


```{r}
IUM83LogCountMatrix <- log2(1+IUM83CountMatrix)

hist(IUM83LogCountMatrix, br = 100)

```

Clean coldata for Deseq2 normalisation

```{r}
colData <- coldata %>% 
  filter(str_detect(Sample, "Pc"))

rownames(colData) <- colData$Sample
colData <- colData [ ,-1] 


# making sure the row names in colData matches to column names in counts_data
all(colnames(IUM83CountMatrix) %in% rownames(colData))
```

```{r}
# Create sample information
sampleNames <- colData$Sample
condition <- colData$Stage
timepoint <- colData$Time

colDATA <- data.frame(sampleNames,
                      condition,
                      timepoint,
                      stringsAsFactors = T)


# Create the DESeqDataSet object
dds <- DESeqDataSetFromMatrix(countData = IUM83CountMatrix,
                              colData = colDATA,
                              design = ~ condition)


nrow(dds)
dds <- dds[rowMeans(counts(dds)) >10,]
nrow(dds)

```

```{r}
vsd <- vst(dds, blind = FALSE)
head(assay(vsd), 3)

rld <- rlog(dds, blind = FALSE)
head(assay(rld), 3)
                    
```

```{r}
ds <- estimateSizeFactors(dds)

df <- bind_rows(
  as.data.frame(log2(counts(dds, normalized=F)[, 1:2]+1)) %>%
         mutate(transformation = "log2(x + 1)"),
  as.data.frame(assay(vsd)[, 1:2]) %>% mutate(transformation = "vst"),
  as.data.frame(assay(rld)[, 1:2]) %>% mutate(transformation = "rlog"))
  
colnames(df)[1:2] <- c("x", "y")  

lvls <- c("log2(x + 1)", "vst", "rlog")
df$transformation <- factor(df$transformation, levels=lvls)

ggplot(df, aes(x = x, y = y)) + geom_hex(bins = 80) +
  coord_fixed() + facet_grid( . ~ transformation) 
```

```{r}
sampleDists <- dist(t(assay(rld)))
sampleDists

sampleDistMatrix <- as.matrix( sampleDists )
rownames(sampleDistMatrix) <- paste( vsd$dex, vsd$cell, sep = " - " )
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists,
         col = colors)

```

```{r}
dds$condition <- relevel(dds$timepoint, ref = "0h")

dds <- DESeq(dds)

as.data.frame(colData(dds))
```
```{r}
PCA <- plotPCA(rld, c("timepoint", "sampleNames"), returnData = TRUE)
percentVar <- round(100 * attr(PCA, "percentVar"))

ggplot(PCA, aes(PC1, PC2, color = condition)) +
  geom_point(size = 5) +
  geom_point(shape = 21, fill = "transparent", colour = "black", size = 5) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  coord_fixed() +
  theme_bw() +
  theme(axis.line = element_line(color = "black"),
        panel.border = element_rect(color = "black"),
        panel.grid.major = element_line(color = "black"),
        panel.grid.minor = element_blank(),
        legend.key = element_rect(fill = "transparent"),  # Remove border for legend objects
        legend.key.size = unit(1, "lines"))  # Increase the size of the legend key

```


```{r}
# To compare "Early" vs "Vegetative"
res_early_vs_vegetative <- results(dds, contrast = c("condition", "18h", "0h"))

# Arrange the results by p-value
res_early_vs_vegetative <- res_early_vs_vegetative[order(res_early_vs_vegetative$pvalue), ]
summary(res_early_vs_vegetative)
res_early_vs_vegetative

up <- rownames(subset(res_early_vs_vegetative, log2FoldChange > 0 & padj < 0.05))
dn <- rownames(subset(res_early_vs_vegetative, log2FoldChange < 0 & padj < 0.05))

# Print the number of upregulated and downregulated genes
str(up)
str(dn)

# MA plot
sig <- subset(res_early_vs_vegetative, padj < 0.05)
GENESUP <- length(up)
GENESDN <- length(dn)
SUBHEADER <- paste(GENESUP, "up, ", GENESDN, "down")

# Create the MA plot
plot(log2(res_early_vs_vegetative$baseMean), res_early_vs_vegetative$log2FoldChange,
     xlab = "log2 basemean", ylab = "log2 foldchange",
     pch = 19, cex = 0.5, col = "dark gray",
     main = "smear plot")
points(log2(sig$baseMean), sig$log2FoldChange,
       pch = 19, cex = 0.5, col = "red")
mtext(SUBHEADER)

# Heatmap
# Get the top 50 most significant genes based on p-value
top_genes <- head(res_early_vs_vegetative[order(res_early_vs_vegetative$pvalue), ], 50)

# Extract the expression values for the top genes
top_gene_expression <- assay(dds)[rownames(top_genes), ]

# Create a matrix of log2-transformed expression values
log2_expression <- log2(top_gene_expression + 1)

# Set the color palette for the heatmap
mycol <- colorRampPalette(c("blue", "white", "red"))(25)

# Create the heatmap using pheatmap
pheatmap(log2_expression, color = mycol, scale = "row",
         cluster_rows = TRUE, cluster_cols = FALSE,
         display_numbers = F, fontsize = 8,
         main = "Top 50 Genes by p-value")

# Extract the expression values for the top genes and select columns 1 to 6
top_gene_expression_subset <- top_gene_expression[, 1:6]

# Create a matrix of log2-transformed expression values
log2_expression <- log2(top_gene_expression_subset + 1)

# Set the color palette for the heatmap
mycol <- colorRampPalette(c("blue", "white", "red"))(25)

# Create the heatmap using pheatmap
pheatmap(log2_expression, color = mycol, scale = "row",
         cluster_rows = TRUE, cluster_cols = T,
         display_numbers = F, fontsize = 8,
         main = "Top 50 Genes by p-value")

```


```{r}
# To compare "Middle" vs "Vegetative"
res_middle_vs_vegetative <- results(dds, contrast =c ("condition", "30h", "0h"))
summary(res_middle_vs_vegetative)
res_middle_vs_vegetative
 
up <- rownames(subset(res_middle_vs_vegetative, log2FoldChange > 0 & padj < 0.05))
dn <- rownames(subset(res_middle_vs_vegetative, log2FoldChange < 0 & padj < 0.05))

# Print the number of upregulated and downregulated genes
str(up)
str(dn)

# MA plot
sig <- subset(res_middle_vs_vegetative, padj < 0.05)
GENESUP <- length(up)
GENESDN <- length(dn)
SUBHEADER <- paste(GENESUP, "up, ", GENESDN, "down")

# Create the MA plot
plot(log2(res_middle_vs_vegetative$baseMean), res_middle_vs_vegetative$log2FoldChange,
     xlab = "log2 basemean", ylab = "log2 foldchange",
     pch = 19, cex = 0.5, col = "dark gray",
     main = "smear plot")
points(log2(sig$baseMean), sig$log2FoldChange,
       pch = 19, cex = 0.5, col = "red")
mtext(SUBHEADER)

# Heatmap
# Get the top 50 most significant genes based on p-value
top_genes <- head(res_middle_vs_vegetative[order(res_middle_vs_vegetative$pvalue), ], 50)

# Extract the expression values for the top genes
top_gene_expression <- assay(dds)[rownames(top_genes), ]

# Create a matrix of log2-transformed expression values
log2_expression <- log2(top_gene_expression + 1)

# Set the color palette for the heatmap
mycol <- colorRampPalette(c("blue", "white", "red"))(25)

# Create the heatmap using pheatmap
pheatmap(log2_expression, color = mycol, scale = "row",
         cluster_rows = TRUE, cluster_cols = FALSE,
         display_numbers = F, fontsize = 8,
         main = "Top 50 Genes by p-value")



# Extract the expression values for the top genes and the selected columns (1 to 3 and 7 to 9)
top_gene_expression_middle <- assay(dds)[rownames(top_genes), c(1:3, 7:9)]

# Create a matrix of log2-transformed expression values
log2_expression_middle <- log2(top_gene_expression_middle + 1)

# Create the heatmap using pheatmap
pheatmap(log2_expression_middle, color = mycol, scale = "row",
         cluster_rows = TRUE, cluster_cols = T,
         display_numbers = F, fontsize = 8,
         main = "Top 50 Genes by p-value (Middle)")
```


```{r}
# To compare "Late" vs "Vegetative"
res_late_vs_vegetative <- results(dds, contrast = c("condition", "48h", "0h"))
summary(res_late_vs_vegetative)
(res_late_vs_vegetative)

up <- rownames(subset(res_late_vs_vegetative, log2FoldChange > 0 & padj < 0.05))
dn <- rownames(subset(res_late_vs_vegetative, log2FoldChange < 0 & padj < 0.05))

# Print the number of upregulated and downregulated genes
str(up)
str(dn)

# MA plot
sig <- subset(res_late_vs_vegetative, padj < 0.05)
GENESUP <- length(up)
GENESDN <- length(dn)
SUBHEADER <- paste(GENESUP, "up, ", GENESDN, "down")

# Create the MA plot
plot(log2(res_late_vs_vegetative$baseMean), res_late_vs_vegetative$log2FoldChange,
     xlab = "log2 basemean", ylab = "log2 foldchange",
     pch = 19, cex = 0.5, col = "dark gray",
     main = "smear plot")
points(log2(sig$baseMean), sig$log2FoldChange,
       pch = 19, cex = 0.5, col = "red")
mtext(SUBHEADER)

# Heatmaps
# Get the top 50 most significant genes based on p-value
top_genes <- head(res_late_vs_vegetative[order(res_late_vs_vegetative$pvalue), ], 50)

# Extract the expression values for the top genes and the selected columns (1 to 3 and 10 to 12)
top_gene_expression_late <- assay(dds)[rownames(top_genes), c(1:3, 10:12)]

# Create a matrix of log2-transformed expression values
log2_expression_late <- log2(top_gene_expression_late + 1)

mycol <- colorRampPalette(c("yellow", "white"))(25)

pheatmap(log2_expression_late, color = mycol, scale = "row",
         cluster_rows = TRUE, cluster_cols = TRUE,
         display_numbers = FALSE, fontsize = 12,
         main = "Top 50 Genes by p-value (Late)",
         cellwidth = 10, cellheight = 20,
         fontsize_row = 12, fontsize_col = 12,
         fontfamily = "Arial", fontface = "bold")

# Create the heatmap using pheatmap
pheatmap(log2_expression_late, color = mycol, scale = "row",
         cluster_rows = TRUE, cluster_cols = T,
         display_numbers = F, fontsize = 8,
         main = "Top 50 Genes by p-value (Late)",
         )
```
```{r}
earlyup <- rownames(subset(res_early_vs_vegetative, log2FoldChange > 2 & padj < 0.05))
midup <- rownames(subset(res_middle_vs_vegetative, log2FoldChange > 2 & padj < 0.05))
lateup <- rownames(subset(res_late_vs_vegetative, log2FoldChange > 2 & padj < 0.05))

venn_list <- list(
  "Early" = earlyup,
  "Middle" = midup,
  "Late" = lateup
)

vennColors <- c("skyblue1", "mediumorchid1", "lightgreen")
venn.plot <- venn.diagram(
  venn_list,
  filename = NULL,
  col = vennColors,
  fill = vennColors,
  alpha = 0.5,
  label.col = "black",
  cex = 0.8,
  fontfamily = "sans",
  cat.col = vennColors,
  cat.cex = 0.8,
  cat.fontfamily = "sans"
)

# Save the plot as an image
png("venn_diagram_up.png", width = 800, height = 600)
grid.draw(venn.plot)
```


```{r}
earlydn <- rownames(subset(res_early_vs_vegetative, log2FoldChange < 2 & padj < 0.05))
middn <- rownames(subset(res_middle_vs_vegetative, log2FoldChange < 2 & padj < 0.05))
latedn <- rownames(subset(res_late_vs_vegetative, log2FoldChange < 2 & padj < 0.05))

venn_list <- list(
  "Early" = earlydn,
  "Middle" = middn,
  "Late" = latedn
)

vennColors <- c("skyblue1", "mediumorchid1", "lightgreen")
venn.plot <- venn.diagram(
  venn_list,
  filename = NULL,
  col = vennColors,
  fill = vennColors,
  alpha = 0.5,
  label.col = "black",
  cex = 0.8,
  fontfamily = "sans",
  cat.col = vennColors,
  cat.cex = 0.8,
  cat.fontfamily = "sans"
)

# Save the plot as an image
png("venn_diagram_down.png", width = 800, height = 600)
grid.draw(venn.plot)
dev.off()

```



```{r, Mitch output}
earlymitch <- as.data.frame(res_early_vs_vegetative)
midmitch <- as.data.frame(res_middle_vs_vegetative)
latemitch <- as.data.frame(res_late_vs_vegetative)

save(earlymitch, midmitch, latemitch, file = "PcMitch.RData")
```





