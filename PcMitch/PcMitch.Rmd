---
title: "PcMitch"
author: "BWSchroeter"
date: "2023-05-24"
output: html_document
---

```{r, lib}
library("mitch")
library("stringi")
```

```{r}
genesets<-gmt_import("goterms.gmt")

load("PcMitch.RData")
```

```{r,import5}
# first rearrange cols
earlymitch2 <- earlymitch
earlymitch2$MyGeneIDs<-rownames(earlymitch2)
rownames(earlymitch2)<-seq(nrow(earlymitch2))
head(earlymitch2)

midmitch2 <- midmitch
midmitch2$MyGeneIDs<-rownames(midmitch2)
rownames(midmitch2)<-seq(nrow(midmitch2))
head(midmitch2)

latemitch2 <- latemitch
latemitch2$MyGeneIDs<-rownames(latemitch2)
rownames(latemitch2)<-seq(nrow(latemitch2))
head(latemitch2)


x<-list("Early"=earlymitch2,"Mid"=midmitch2, "Late"=latemitch2)
y<-mitch_import(x,"DESeq2")

```
```{r,import6}
# obtain vector of gene names
genenames<-rownames(earlymitch)
# create fake accession numbers
accessions<-paste("Gene0",stri_rand_strings(nrow(earlymitch)*2, 6, pattern = "[0-9]"),sep="")
accessions<-head(unique(accessions),nrow(earlymitch))
# create a gene table file that relates gene names to accession numbers
gt<-data.frame(genenames,accessions)

# now swap gene names for accessions
earlymitch2<-merge(earlymitch,gt,by.x=0,by.y="genenames")
rownames(earlymitch2)<-earlymitch2$accessions
earlymitch2<-earlymitch2[,2:5]

midmitch2<-merge(midmitch,gt,by.x=0,by.y="genenames")
rownames(midmitch2)<-midmitch2$accessions
midmitch2<-midmitch2[,2:5]

latemitch2<-merge(latemitch,gt,by.x=0,by.y="genenames")
rownames(latemitch2)<-latemitch2$accessions
latemitch2<-latemitch2[,2:5]


# now have a peek at the input data before importing
head(earlymitch2,3)
head(midmitch2,3)
head(latemitch2,3)
head(gt,3)
x<-list("Early"=earlymitch2,"Middle"=midmitch2, "Late"=latemitch2)
y<-mitch_import(x,DEtype="DESeq2",geneTable=gt)
head(y,3)
```

```{r,calc1,results="hide"}
# prioritisation by significance
res<-mitch_calc(y,genesets,priority="significance",cores=2)
```
```{r,calc2}
# peek at the results
head(res$enrichment_result)
```
```{r,calc3,results="hide"}
# prioritisation by effect size
res<-mitch_calc(y,genesets,priority="effect",cores=2)
```
```{r,calc4}
head(res$enrichment_result)
```
```{r,calc5,results="hide"}
# prioritisation by SD
res<-mitch_calc(y,genesets,priority="SD",cores=2)
```

By default, in downstream visualisation steps, charts are made from the top 50 gene sets, but this can be 
modified using the resrows option.

```{r,calc6,results="hide"}
head(res$enrichment_result)
```

## Generate a HTML report
The HTML reports contain several plots as raster images and interactive charts
which are useful as a first-pass visualisation. These can be generated like
this:

```{r,report,results="hide"}
mitch_report(res,"Pcreport.html")
```

## Generate high resolution plots
In case you want the charts in PDF format, for example for publications, these
can be generated as such:

```{r,plots,results="hide"}
mitch_plots(res,outfile="Pccharts.pdf")
```